# Expense Tracker - Makefile
# Comandos para desenvolvimento e produ√ß√£o

.PHONY: help install dev dev-back dev-report build up down logs ps health

# ============================================================================
# COMANDOS DOCKER (TUDO EM UM)
# ============================================================================

# Sobe TUDO em containers (PostgreSQL, Redis, Report Service, Backend, Frontend)
up:
	@echo "üöÄ Subindo todos os servi√ßos..."
	docker-compose up --build -d
	@echo ""
	@echo "‚úÖ Servi√ßos dispon√≠veis:"
	@echo "   Frontend:    http://localhost:8085"
	@echo "   Backend API: http://localhost:3001/api/v1"
	@echo "   Report Svc:  http://localhost:3002"
	@echo "   MinIO:       http://localhost:9001 (minioadmin/minioadmin)"
	@echo ""
	@sleep 3
	@make health

# Para todos os servi√ßos
down:
	@echo "üõë Parando todos os servi√ßos..."
	docker-compose down

# Para e remove volumes (limpa tudo)
clean:
	@echo "üßπ Limpando containers e volumes..."
	docker-compose down -v
	docker system prune -f

# Mostra logs de todos os servi√ßos
logs:
	docker-compose logs -f

# Mostra logs de um servi√ßo espec√≠fico
logs-back:
	docker-compose logs -f backend

logs-report:
	docker-compose logs -f report-service

logs-db:
	docker-compose logs -f postgres

# Status dos containers
ps:
	docker-compose ps

# Verifica sa√∫de dos servi√ßos
health:
	@echo ""
	@echo "üè• Verificando sa√∫de dos servi√ßos..."
	@echo ""
	@echo -n "PostgreSQL:  "
	@docker-compose exec -T postgres pg_isready -U postgres >/dev/null 2>&1 && echo "‚úÖ OK" || echo "‚ùå Falha"
	@echo -n "Redis:       "
	@docker-compose exec -T redis redis-cli ping >/dev/null 2>&1 && echo "‚úÖ OK" || echo "‚ùå Falha"
	@echo -n "Report Svc:  "
	@curl -s http://localhost:3002/health >/dev/null 2>&1 && echo "‚úÖ OK" || echo "‚ùå Falha"
	@echo -n "Backend:     "
	@curl -s http://localhost:3001/api/v1/health >/dev/null 2>&1 && echo "‚úÖ OK" || echo "‚ùå Falha"
	@echo -n "Frontend:    "
	@curl -s http://localhost:8085 >/dev/null 2>&1 && echo "‚úÖ OK" || echo "‚ùå Falha"
	@echo ""

# ============================================================================
# COMANDOS DE DESENVOLVIMENTO (SEM DOCKER)
# ============================================================================

# Instala depend√™ncias de todos os projetos
install:
	@echo "üì¶ Instalando depend√™ncias..."
	@echo ""
	@echo "‚Üí Backend..."
	cd back && npm install
	@echo ""
	@echo "‚Üí Report Service..."
	cd report-service && npm install
	@echo ""
	@echo "‚Üí Frontend..."
	cd front && npm install
	@echo ""
	@echo "‚úÖ Instala√ß√£o completa!"

# Build em todos os projetos
build:
	@echo "üî® Fazendo build..."
	@echo ""
	@echo "‚Üí Report Service..."
	cd report-service && npm run build
	@echo ""
	@echo "‚Üí Backend..."
	cd back && npm run build
	@echo ""
	@echo "‚Üí Frontend..."
	cd front && npm run build
	@echo ""
	@echo "‚úÖ Build completo!"

# ============================================================================
# COMANDOS DE DESENVOLVIMENTO INDIVIDUAIS
# ============================================================================

# Desenvolvimento - apenas infraestrutura (DB, Redis, MinIO)
dev-infra:
	@echo "üê≥ Subindo infraestrutura (PostgreSQL, Redis, MinIO)..."
	docker-compose up -d postgres redis minio
	@echo "Aguardando servi√ßos ficarem prontos..."
	@sleep 5
	@echo ""
	@echo "‚úÖ Infraestrutura pronta!"
	@echo "   PostgreSQL: localhost:5432"
	@echo "   Redis:      localhost:6379"
	@echo "   MinIO:      localhost:9000"

# Desenvolvimento - Report Service apenas
dev-report:
	cd report-service && npm run dev

# Desenvolvimento - Backend apenas
dev-back:
	cd back && npm run start:dev

# Desenvolvimento - Frontend apenas  
dev-front:
	cd front && npm run dev

# ============================================================================
# UTILIT√ÅRIOS
# ============================================================================

# Help
help:
	@echo "================================================================"
	@echo "  EXPENSE TRACKER - COMANDOS DISPON√çVEIS"
	@echo "================================================================"
	@echo ""
	@echo "üê≥ DOCKER (TUDO EM UM):"
	@echo "  make up           - Sobe TUDO (DB, Redis, Report, Backend, Front)"
	@echo "  make down         - Para todos os servi√ßos"
	@echo "  make clean        - Para e remove volumes (limpa tudo)"
	@echo "  make logs         - Mostra logs de todos os servi√ßos"
	@echo "  make ps           - Mostra status dos containers"
	@echo "  make health       - Verifica sa√∫de dos servi√ßos"
	@echo ""
	@echo "üê≥ LOGS ESPEC√çFICOS:"
	@echo "  make logs-back    - Logs do backend"
	@echo "  make logs-report  - Logs do report service"
	@echo "  make logs-db      - Logs do PostgreSQL"
	@echo ""
	@echo "üíª DESENVOLVIMENTO LOCAL:"
	@echo "  make install      - Instala depend√™ncias de todos os projetos"
	@echo "  make build        - Faz build de todos os projetos"
	@echo "  make dev-infra    - Sobe s√≥ infraestrutura (DB, Redis, MinIO)"
	@echo "  make dev-report   - Report Service (npm run dev)"
	@echo "  make dev-back     - Backend (npm run start:dev)"
	@echo "  make dev-front    - Frontend (npm run dev)"
	@echo ""
	@echo "================================================================"

# Default
.DEFAULT_GOAL := help
