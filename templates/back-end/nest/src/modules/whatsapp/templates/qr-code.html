<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp QR Code - Central de Vagas</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .qr-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #25d366;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .instructions {
            text-align: left;
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .refresh-btn {
            background-color: #25d366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .refresh-btn:hover { background-color: #128c7e; }
        .refresh-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25d366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Central de Vagas - WhatsApp</h1>
        <h2>üì± Conectar WhatsApp</h2>
        
        <div id="status-container"></div>
        <div id="qr-container" class="qr-container" style="display: none;">
            <canvas id="qr-canvas"></canvas>
            <p><strong>Escaneie o QR Code com seu WhatsApp</strong></p>
        </div>
        
        <div class="instructions">
            <h3>üì≤ Como conectar:</h3>
            <ol>
                <li>Abra o <strong>WhatsApp</strong> no seu celular</li>
                <li>V√° em <strong>Menu</strong> ‚Üí <strong>Aparelhos Conectados</strong></li>
                <li>Toque em <strong>Conectar um aparelho</strong></li>
                <li>Escaneie o QR Code acima</li>
                <li>Aguarde a confirma√ß√£o de conex√£o</li>
            </ol>
        </div>
        
        <button id="refresh-btn" class="refresh-btn" onclick="checkStatus()">
            <span id="refresh-text">üîÑ Verificar Status</span>
            <span id="loading" class="loading" style="display: none;"></span>
        </button>
        
        <div id="debug-info" style="margin-top: 20px; font-size: 12px; color: #666;"></div>
    </div>

    <script>
        let refreshInterval;
        
        async function checkStatus() {
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshText = document.getElementById('refresh-text');
            const loading = document.getElementById('loading');
            const statusContainer = document.getElementById('status-container');
            const qrContainer = document.getElementById('qr-container');
            const debugInfo = document.getElementById('debug-info');
            
            // Mostrar loading
            refreshBtn.disabled = true;
            refreshText.style.display = 'none';
            loading.style.display = 'inline-block';
            
            try {
                const response = await fetch('/whatsapp/qr-code');
                const data = await response.json();
                
                debugInfo.innerHTML = `
                    <strong>Debug Info:</strong><br>
                    √öltima verifica√ß√£o: ${new Date().toLocaleString()}<br>
                    Response: ${JSON.stringify(data, null, 2)}
                `;
                
                statusContainer.innerHTML = '';
                qrContainer.style.display = 'none';
                
                if (!data.available) {
                    if (data.status === 'connected') {
                        statusContainer.innerHTML = `
                            <div class="status success">
                                ‚úÖ <strong>WhatsApp Conectado!</strong><br>
                                ${data.message}
                            </div>
                        `;
                        clearInterval(refreshInterval);
                    } else {
                        statusContainer.innerHTML = `
                            <div class="status warning">
                                ‚è≥ <strong>Aguardando...</strong><br>
                                ${data.message}
                            </div>
                        `;
                    }
                } else {
                    statusContainer.innerHTML = `
                        <div class="status success">
                            üì± <strong>QR Code Dispon√≠vel</strong><br>
                            ${data.message}
                        </div>
                    `;
                    
                    // Gerar QR Code visual
                    const canvas = document.getElementById('qr-canvas');
                    QRCode.toCanvas(canvas, data.qrCode, {
                        width: 256,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    });
                    
                    qrContainer.style.display = 'block';
                    
                    // Auto-refresh a cada 5 segundos
                    if (!refreshInterval) {
                        refreshInterval = setInterval(checkStatus, 5000);
                    }
                }
                
            } catch (error) {
                statusContainer.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Erro de Conex√£o</strong><br>
                        N√£o foi poss√≠vel conectar ao servidor: ${error.message}
                    </div>
                `;
                debugInfo.innerHTML = `<strong>Erro:</strong> ${error.message}`;
            } finally {
                // Esconder loading
                refreshBtn.disabled = false;
                refreshText.style.display = 'inline';
                loading.style.display = 'none';
            }
        }
        
        // Verificar status ao carregar a p√°gina
        window.onload = function() {
            checkStatus();
        };
        
        // Limpar interval quando a p√°gina for fechada
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        };
    </script>
</body>
</html>
